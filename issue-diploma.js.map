{"version":3,"file":"issue-diploma.js","sources":["../src/issue-diploma.js"],"sourcesContent":["import {createI18nInstance} from './i18n.js';\nimport {css, html} from 'lit-element';\nimport {ScopedElementsMixin} from '@open-wc/scoped-elements';\nimport * as commonUtils from '@dbp-toolkit/common/utils';\nimport {Button, Icon} from '@dbp-toolkit/common';\nimport * as commonStyles from '@dbp-toolkit/common/styles';\nimport {AdapterLitElement} from '@dbp-toolkit/provider/src/adapter-lit-element';\nimport QRCode from 'webcomponent-qr-code/qr-code';\n\nconst i18n = createI18nInstance();\n\n\nclass IssueDiploma extends ScopedElementsMixin(AdapterLitElement) {\n    constructor() {\n        super();\n        this.auth = {};\n        this.entryPointUrl = '';\n        this.lang = i18n.language;\n        this.exporting = false;\n    }\n\n    static get scopedElements() {\n        return {\n            'dbp-icon': Icon,\n            'dbp-button': Button,\n            'dbp-qr-code': QRCode,\n        };\n    }\n\n    static get properties() {\n        return {\n            ...super.properties,\n            lang: { type: String },\n            exporting: { type: Boolean, attribute: false },\n            exportingId: { type: String },\n            diplomas: { type: Array },\n            auth: { type: Object },\n            entryPointUrl: { type: String, attribute: 'entry-point-url' },\n        };\n    }\n\n    connectedCallback() {\n        super.connectedCallback();\n    }\n\n    update(changedProperties) {\n        changedProperties.forEach((oldValue, propName) => {\n            switch (propName) {\n                case \"lang\":\n                    i18n.changeLanguage(this.lang);\n                    break;\n                case \"entryPointUrl\":\n                    this.fetchDiplomas().then((diplomas) => {\n                        this.diplomas = diplomas;\n                    });\n                    break;\n            }\n        });\n\n        super.update(changedProperties);\n    }\n\n    static get styles() {\n        // language=css\n        return css`\n            ${commonStyles.getThemeCSS()}\n            \n            .vc-list {\n              list-style: none;\n              padding: 0;\n            }\n\n            .vc-list li {\n              display: flex;\n              justify-content: space-between;\n              margin-bottom: 1rem;\n            }\n\n            .success {\n                font-size: 10rem;\n                line-height: 10rem;\n                color: green;\n            }\n        `;\n    }\n\n    async triggerSendOffer(myDid, theirDid, id) {\n        const options = {\n            method: 'post',\n            headers: {\n                Authorization: \"Bearer \" + this.auth.token,\n                'Content-Type': 'application/ld+json'\n            },\n            body: JSON.stringify({\n                myDid,\n                theirDid,\n                status: id\n            })\n        };\n        const url = this.entryPointUrl + '/credential/send_offer';\n        const resp = await this.httpGetAsync(url, options);\n        return resp;\n    }\n\n    async acceptRequest(piid, id) {\n        // todo: don't send id via status field.\n        const options = {\n            method: 'post',\n            headers: {\n                Authorization: \"Bearer \" + this.auth.token,\n                'Content-Type': 'application/ld+json'\n            },\n            body: JSON.stringify({\n                myDid: piid,\n                theirDid: 'none',\n                status: id\n            })\n        };\n        const url = this.entryPointUrl + '/credential/accept_request';\n        const resp = await this.httpGetAsync(url, options);\n        return resp;\n    }\n\n    async export(id) {\n        console.log('export diploma', id);\n\n        const myDID = sessionStorage.getItem('did-comm-MyDID');\n        const theirDID = sessionStorage.getItem('did-comm-TheirDID');\n\n        if (!myDID || !theirDID) {\n            alert('No wallet app connected. Please connect your wallet first.');\n            return;\n        }\n\n        const res = await this.triggerSendOffer(myDID, theirDID, id);\n        console.log('triggerSendOffer', res);\n        const piid = JSON.parse(res.myDid).piid;\n\n        const invervalId = setInterval(async () => {\n            const res2 = await this.acceptRequest(piid, id);\n            if (res2.myDid !== '') {\n                console.log('request accepted');\n\n                clearInterval(invervalId);\n\n                this.exporting = true;\n                this.exportingId = id;\n            }\n        }, 1000);\n    }\n\n    async httpGetAsync(url, options) {\n        let response = await fetch(url, options).then(result => {\n            if (!result.ok) throw result;\n            return result.json();\n        });\n\n        return response;\n    }\n\n    async fetchDiplomas() {\n        const options = {\n            headers: {\n                Authorization: \"Bearer \" + this.auth.token\n            }\n        };\n        const url = this.entryPointUrl + '/diplomas?page=1';\n        const resp = await this.httpGetAsync(url, options);\n        return resp['hydra:member'];\n    }\n\n    // todo: maybe derive diploma and grades from the same activity\n    // todo: check for login\n    // todo: check if did auth is done\n    // todo: fetch list of diplomas\n    // todo: modal with vc qr code\n    // todo: select format, select schema\n    render() {\n        if (!this.auth.token) {\n            return html`\n                <p>${i18n.t('please-login')}</p>\n            `;\n        }\n\n        if (!this.exporting) {\n\n            const diplomaList = this.diplomas.map((d) => html`\n                <li>\n                    <div>\n                        <strong>${d.name}</strong><br />\n                        ${d.academicDegree}<br />\n                        ${d.achievenmentDate}<br />\n                    </div>\n                    <dbp-button type=\"is-primary\" value=\"Export\" no-spinner-on-click=\"true\" @click=\"${() => this.export(d['@id'])}\" />\n                </li>\n            `);\n\n            return html`\n                <ul class=\"vc-list\">\n                    ${diplomaList}\n                </ul>\n            `;\n        }\n\n        return html`\n            <p>\n                ${i18n.t('issue-diploma.scan')}\n            </p>\n\n            <span class=\"success\">âœ”</span><br />\n            \n            <pre>${JSON.stringify(this.diplomas.filter((d) => d['@id'] === this.exportingId)[0], null, 2)}</pre>\n        `;\n    }\n}\n\ncommonUtils.defineCustomElement('issue-diploma', IssueDiploma);\n"],"names":["i18n","createI18nInstance","IssueDiploma","ScopedElementsMixin","AdapterLitElement","constructor","auth","entryPointUrl","lang","language","exporting","Icon","Button","QRCode","super","properties","type","String","Boolean","attribute","exportingId","diplomas","Array","Object","connectedCallback","update","changedProperties","forEach","oldValue","propName","changeLanguage","this","fetchDiplomas","then","css","commonStyles.getThemeCSS","myDid","theirDid","id","options","method","headers","Authorization","token","body","JSON","stringify","status","url","httpGetAsync","piid","console","log","myDID","sessionStorage","getItem","theirDID","alert","res","triggerSendOffer","parse","invervalId","setInterval","async","_this","acceptRequest","clearInterval","fetch","result","ok","json","render","html","t","diplomaList","map","d","name","academicDegree","achievenmentDate","export","filter","commonUtils.defineCustomElement"],"mappings":";;;;;;;;;;;;;;iOASA,MAAMA,EAAOC,IAGb,MAAMC,UAAqBC,EAAoBC,IAC3CC,2BAESC,KAAO,QACPC,cAAgB,QAChBC,KAAOR,EAAKS,cACZC,WAAY,oCAIV,YACSC,eACEC,gBACCC,uCAMZC,MAAMC,YACTP,KAAM,CAAEQ,KAAMC,QACdP,UAAW,CAAEM,KAAME,QAASC,WAAW,GACvCC,YAAa,CAAEJ,KAAMC,QACrBI,SAAU,CAAEL,KAAMM,OAClBhB,KAAM,CAAEU,KAAMO,QACdhB,cAAe,CAAES,KAAMC,OAAQE,UAAW,qBAIlDK,0BACUA,oBAGVC,OAAOC,GACHA,EAAkBC,SAAQ,CAACC,EAAUC,YACzBA,OACC,OACD7B,EAAK8B,eAAeC,KAAKvB,gBAExB,qBACIwB,gBAAgBC,MAAMZ,SAClBA,SAAWA,eAM1BI,OAAOC,8BAKNQ,SAAI;cAAX;;;;;;;;;;;;;;;;;;WACMC,4BAqBaC,EAAOC,EAAUC,SAC9BC,EAAU,CACZC,OAAQ,OACRC,QAAS,CACLC,cAAe,UAAYX,KAAKzB,KAAKqC,qBACrB,uBAEpBC,KAAMC,KAAKC,UAAU,CACjBV,MAAAA,EACAC,SAAAA,EACAU,OAAQT,KAGVU,EAAMjB,KAAKxB,cAAgB,sCACdwB,KAAKkB,aAAaD,EAAKT,uBAI1BW,EAAMZ,SAEhBC,EAAU,CACZC,OAAQ,OACRC,QAAS,CACLC,cAAe,UAAYX,KAAKzB,KAAKqC,qBACrB,uBAEpBC,KAAMC,KAAKC,UAAU,CACjBV,MAAOc,EACPb,SAAU,OACVU,OAAQT,KAGVU,EAAMjB,KAAKxB,cAAgB,0CACdwB,KAAKkB,aAAaD,EAAKT,gBAIjCD,cACTa,QAAQC,IAAI,iBAAkBd,SAExBe,EAAQC,eAAeC,QAAQ,kBAC/BC,EAAWF,eAAeC,QAAQ,yBAEnCF,IAAUG,cACXC,MAAM,oEAIJC,QAAY3B,KAAK4B,iBAAiBN,EAAOG,EAAUlB,GACzDa,QAAQC,IAAI,mBAAoBM,SAC1BR,EAAOL,KAAKe,MAAMF,EAAItB,OAAOc,KAE7BW,EAAaC,aAAYC,iBAER,YADAC,EAAKC,cAAcf,EAAMZ,IACnCF,QACLe,QAAQC,IAAI,oBAEZc,cAAcL,GAEdG,EAAKtD,WAAY,EACjBsD,EAAK5C,YAAckB,KAExB,wBAGYU,EAAKT,gBACC4B,MAAMnB,EAAKT,GAASN,MAAKmC,QACrCA,EAAOC,GAAI,MAAMD,SACfA,EAAOE,sCAOZ/B,EAAU,CACZE,QAAS,CACLC,cAAe,UAAYX,KAAKzB,KAAKqC,QAGvCK,EAAMjB,KAAKxB,cAAgB,gCACdwB,KAAKkB,aAAaD,EAAKT,IAC9B,gBAShBgC,aACSxC,KAAKzB,KAAKqC,aACJ6B,SAAK;qBAAZ;eACSxE,EAAKyE,EAAE,qBAIf1C,KAAKrB,UAAW,OAEXgE,EAAc3C,KAAKV,SAASsD,KAAKC,GAAMJ,SAAK;;;kCAAZ;0BAAA;0BAAA;;sGAAA;;eAGhBI,EAAEC,KACVD,EAAEE,eACFF,EAAEG,kBAE0E,IAAMhD,KAAKiD,OAAOJ,EAAE,mBAIvGJ,SAAK;;sBAAZ;;eAEUE,UAKPF,SAAK;;kBAAZ;;;;;mBAAA;WAEUxE,EAAKyE,EAAE,sBAKN5B,KAAKC,UAAUf,KAAKV,SAAS4D,QAAQL,GAAMA,EAAE,SAAW7C,KAAKX,cAAa,GAAI,KAAM,KAKvG8D,EAAgC,gBAAiBhF"}